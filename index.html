<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Chat</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif;}
    html,body{height:100%;overflow:hidden;background:#2c2f33;color:#fff;}
    #loginPage{display:flex;justify-content:center;align-items:center;height:100vh;flex-direction:column;gap:10px;}
    #loginPage input,#loginPage button{width:280px;padding:10px;border-radius:6px;border:none;}
    #loginPage input{background:#23272a;color:#fff;}
    #loginPage button{background:#7289da;color:#fff;cursor:pointer;}
    #chatPage{display:none;height:100vh;width:100%;flex-direction:row;}
    #sidebar{width:240px;background:#23272a;padding:12px;overflow-y:auto;border-right:1px solid #1f2124;}
    #userList{list-style:none;padding:0;}
    #chatContainer{flex:1;display:flex;flex-direction:column;padding:12px;}
    #chatBox{flex:1;background:#2c2f33;border-radius:8px;overflow-y:auto;padding:10px;margin-bottom:10px;border:1px solid #1f2124;}
    .message{padding:10px;border-radius:12px;margin-bottom:8px;max-width:70%;word-wrap:break-word;}
    .message.mine{background:#7289da;margin-left:auto;}
    .message.other{background:#99aab5;margin-right:auto;color:#141414;}
    #inputRow{display:flex;gap:8px;}
    #messageInput{flex:1;padding:10px;border-radius:8px;border:none;background:#23272a;color:#fff;}
    #sendBtn{padding:10px 16px;border-radius:8px;border:none;background:#43b581;color:#fff;cursor:pointer;}
  </style>
  <script src="config.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>

<div id="loginPage">
  <h2>Chat</h2>
  <input type="text" id="username" placeholder="Kullanıcı adı" />
  <input type="password" id="password" placeholder="Şifre" />
  <button id="loginBtn">Giriş Yap</button>
  <button id="registerBtn">Kayıt Ol</button>
</div>

<div id="chatPage">
  <div id="sidebar">
    <h3>Online Kullanıcılar</h3>
    <ul id="userList"></ul>
    <button id="logoutBtn">Çıkış</button>
  </div>
  <div id="chatContainer">
    <div id="chatBox"></div>
    <div id="inputRow">
      <input type="text" id="messageInput" placeholder="Mesaj yaz..." />
      <button id="sendBtn">Gönder</button>
    </div>
  </div>
</div>

<script>
  // Init Firebase (config.js içinde const firebaseConfig = { ... } olmalı)
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.database();

  let currentUser = null;

  // Presence helpers
  function setOnline(username){
    db.ref("onlineUsers/"+username).set({online:true, at:Date.now()});
    db.ref("onlineUsers/"+username).onDisconnect().remove();
  }
  function setOffline(username){
    db.ref("onlineUsers/"+username).remove();
  }

  // UI helpers
  function showChat(){
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("chatPage").style.display  = "flex";
    loadMessages();
    loadUsers();
  }
  function showLogin(){
    document.getElementById("chatPage").style.display  = "none";
    document.getElementById("loginPage").style.display = "flex";
  }

  // Load messages (persist across reloads)
  function loadMessages(){
    const chatBox = document.getElementById("chatBox");
    db.ref("messages").off();
    db.ref("messages").on("child_added", snap => {
      const data = snap.val();
      const div = document.createElement("div");
      div.classList.add("message");
      const myName = currentUser.email.split("@")[0];
      div.classList.add(data.user === myName ? "mine" : "other");
      div.textContent = data.user + ": " + data.message;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }

  // Load online users
  function loadUsers(){
    const ul = document.getElementById("userList");
    db.ref("onlineUsers").off();
    db.ref("onlineUsers").on("value", snap => {
      ul.innerHTML = "";
      snap.forEach(u => {
        const li = document.createElement("li");
        li.textContent = u.key;
        ul.appendChild(li);
      });
    });
  }

  // Send message
  function sendMessage(){
    const inp = document.getElementById("messageInput");
    const msg = inp.value.trim();
    if(!msg) return;
    const uname = currentUser.email.split("@")[0];
    db.ref("messages").push({ user: uname, message: msg, timestamp: Date.now() })
      .then(() => { inp.value = ""; })
      .catch(err => { alert("Yazma hatası: " + err.code); });
  }

  // Auth actions
  document.getElementById("registerBtn").onclick = () => {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();
    if(!username || !password) return alert("Boş bırakma");
    auth.createUserWithEmailAndPassword(username+"@chat.com", password)
      .then(u => {
        currentUser = u.user;
        setOnline(username);
        showChat();
      })
      .catch(err => alert(err.message));
  };

  document.getElementById("loginBtn").onclick = () => {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();
    if(!username || !password) return alert("Boş bırakma");
    auth.signInWithEmailAndPassword(username+"@chat.com", password)
      .then(u => {
        currentUser = u.user;
        setOnline(username);
        showChat();
      })
      .catch(err => alert("Giriş hatası: " + err.code));
  };

  document.getElementById("logoutBtn").onclick = async () => {
    if(!currentUser) return;
    const uname = currentUser.email.split("@")[0];
    setOffline(uname);
    await auth.signOut();
    currentUser = null;
    showLogin();
  };

  // Send events
  document.getElementById("sendBtn").onclick = sendMessage;
  document.getElementById("messageInput").addEventListener("keypress", e => {
    if(e.key === "Enter") sendMessage();
  });

  // Session restore
  auth.onAuthStateChanged(user => {
    if(user){
      currentUser = user;
      const uname = user.email.split("@")[0];
      setOnline(uname);
      showChat();
    } else {
      showLogin();
    }
  });
</script>
</body>
</html>