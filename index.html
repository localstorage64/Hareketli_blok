<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Firebase Chat</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <script src="src/config.js"></script>
  <style>
    body { font-family: Arial; margin:0; padding:0; }
    #login, #register, #chat, #adminPanel { display:none; padding:20px; }
    #users { float:left; width:20%; border-right:1px solid #ccc; height:400px; overflow-y:auto; }
    #messages { float:left; width:60%; height:400px; overflow-y:auto; padding:10px; }
    #sendBox { clear:both; padding:10px; }
    .msg { margin:5px 0; }
  </style>
</head>
<body>

  <!-- Giriş -->
  <div id="login">
    <h2>Giriş Yap</h2>
    <input id="loginEmail" placeholder="Email"><br>
    <input id="loginPass" type="password" placeholder="Şifre"><br>
    <button onclick="login()">Giriş Yap</button>
    <button onclick="showRegister()">Kayıt Ol</button>
  </div>

  <!-- Kayıt -->
  <div id="register">
    <h2>Kayıt Ol</h2>
    <input id="regEmail" placeholder="Email"><br>
    <input id="regPass" type="password" placeholder="Şifre"><br>
    <button onclick="register()">Kaydet</button>
    <button onclick="showLogin()">Geri</button>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel">
    <h2>Admin Panel</h2>
    <button onclick="clearMessages()">Tüm Mesajları Sil</button>
    <input id="banUser" placeholder="Banlanacak kullanıcı email">
    <button onclick="ban()">Banla</button>
    <button onclick="goChat()">Chat'e Geç</button>
  </div>

  <!-- Chat -->
  <div id="chat">
    <div id="users"></div>
    <div id="messages"></div>
    <div id="sendBox">
      <input id="msgInput" placeholder="Mesaj yaz...">
      <button onclick="sendMessage()">Gönder</button>
    </div>
  </div>

<script>
  // Firebase başlat
  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.getAuth(app);
  const db = firebase.getFirestore(app);

  let currentUser = null;
  let bannedUsers = [];

  function showLogin(){ document.getElementById("register").style.display="none"; document.getElementById("login").style.display="block"; }
  function showRegister(){ document.getElementById("login").style.display="none"; document.getElementById("register").style.display="block"; }

  async function register(){
    let email = document.getElementById("regEmail").value;
    let pass = document.getElementById("regPass").value;
    await firebase.createUserWithEmailAndPassword(auth, email, pass);
    alert("Kayıt başarılı!");
    showLogin();
  }

  async function login(){
    let email = document.getElementById("loginEmail").value;
    let pass = document.getElementById("loginPass").value;
    try {
      let userCred = await firebase.signInWithEmailAndPassword(auth, email, pass);
      currentUser = userCred.user.email;
      if(currentUser === "admin@site.com"){ // admin hesabı
        document.getElementById("login").style.display="none";
        document.getElementById("adminPanel").style.display="block";
      } else {
        document.getElementById("login").style.display="none";
        document.getElementById("chat").style.display="block";
        addUser(currentUser);
        listenMessages();
        listenUsers();
      }
    } catch(e){ alert("Hatalı giriş: "+e.message); }
  }

  function goChat(){
    document.getElementById("adminPanel").style.display="none";
    document.getElementById("chat").style.display="block";
    addUser("admin@site.com");
    listenMessages();
    listenUsers();
  }

  async function sendMessage(){
    if(bannedUsers.includes(currentUser)){ alert("Banlandın!"); return; }
    let msg = document.getElementById("msgInput").value;
    if(msg){
      await firebase.addDoc(firebase.collection(db,"messages"),{
        user: currentUser,
        text: msg,
        time: Date.now()
      });
      document.getElementById("msgInput").value="";
    }
  }

  function addUser(name){
    let div = document.createElement("div");
    div.textContent = name;
    document.getElementById("users").appendChild(div);
  }

  async function clearMessages(){
    let snap = await firebase.getDocs(firebase.collection(db,"messages"));
    snap.forEach(async d => { await firebase.deleteDoc(d.ref); });
  }

  function ban(){
    let u = document.getElementById("banUser").value;
    if(u){ bannedUsers.push(u); alert(u+" banlandı!"); }
  }

  function listenMessages(){
    firebase.onSnapshot(firebase.collection(db,"messages"), snap=>{
      document.getElementById("messages").innerHTML="";
      snap.forEach(doc=>{
        let d = doc.data();
        let div = document.createElement("div");
        div.className="msg";
        div.textContent = d.user+": "+d.text;
        document.getElementById("messages").appendChild(div);
      });
    });
  }

  function listenUsers(){
    // basitçe aktif kullanıcıyı gösteriyoruz
    document.getElementById("users").innerHTML="";
    addUser(currentUser);
  }

  showLogin();
</script>
</body>
</html>